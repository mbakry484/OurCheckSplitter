<!DOCTYPE html>
<html>
  <head>
    <title>Check Splitter API Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 0 20px;
      }
      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      button {
        margin: 5px;
        padding: 5px 10px;
      }
      input,
      select {
        margin: 5px;
        padding: 5px;
      }
      .result {
        margin-top: 10px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 3px;
        white-space: pre-wrap;
      }
      .error {
        color: red;
        background-color: #ffebee;
      }
    </style>
  </head>
  <body>
    <h1>Check Splitter API Test</h1>

    <div class="section">
      <h2>Friends</h2>
      <div>
        <input type="text" id="friendName" placeholder="Friend Name" />
        <button onclick="createFriend()">Create Friend</button>
      </div>
      <div>
        <button onclick="getAllFriends()">Get All Friends</button>
      </div>
      <div class="result" id="friendsResult"></div>
    </div>

    <div class="section">
      <h2>Receipt</h2>
      <div>
        <input type="text" id="receiptName" placeholder="Receipt Name" />
        <input type="number" id="receiptTax" placeholder="Tax" step="0.01" />
        <input type="number" id="receiptTips" placeholder="Tips" step="0.01" />
        <input
          type="number"
          id="receiptTotal"
          placeholder="Total"
          step="0.01"
        />
        <button onclick="createReceipt()">Create Receipt</button>
      </div>
      <div>
        <button onclick="getAllReceipts()">Get All Receipts</button>
      </div>
      <div class="result" id="receiptsResult"></div>
    </div>

    <div class="section">
      <h2>Items</h2>
      <div>
        <select id="receiptSelect">
          <option value="">Select a Receipt</option>
        </select>
        <input type="text" id="itemName" placeholder="Item Name" />
        <input type="number" id="itemPrice" placeholder="Price" step="0.01" />
        <button onclick="addItem()">Add Item</button>
      </div>
      <div class="result" id="itemsResult"></div>
    </div>

    <div class="section">
      <h2>Assign Friends to Receipt</h2>
      <div>
        <select id="receiptSelectForFriends">
          <option value="">Select a Receipt</option>
        </select>
        <div id="friendCheckboxes"></div>
        <button onclick="assignFriendsToReceipt()">Assign Friends</button>
      </div>
      <div class="result" id="assignmentResult"></div>
    </div>

    <script>
      // Utility function to display results
      function displayResult(elementId, data, isError = false) {
        const element = document.getElementById(elementId);
        element.textContent =
          typeof data === "string" ? data : JSON.stringify(data, null, 2);
        element.className = "result" + (isError ? " error" : "");
      }

      // Utility function to make API calls
      async function apiCall(url, method = "GET", body = null) {
        try {
          const response = await fetch(url, {
            method,
            headers: body ? { "Content-Type": "application/json" } : {},
            body: body ? JSON.stringify(body) : null,
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const contentType = response.headers.get("content-type");
          if (contentType && contentType.includes("application/json")) {
            return await response.json();
          } else {
            return await response.text();
          }
        } catch (error) {
          console.error("API call failed:", error);
          throw error;
        }
      }

      // Friends API
      async function createFriend() {
        try {
          const name = document.getElementById("friendName").value;
          if (!name) {
            throw new Error("Friend name is required");
          }
          const result = await apiCall("/api/friends", "POST", { name });
          displayResult("friendsResult", result);
          await updateFriendsList();
          document.getElementById("friendName").value = "";
        } catch (error) {
          displayResult("friendsResult", error.message, true);
        }
      }

      async function getAllFriends() {
        try {
          const friends = await apiCall("/api/friends");
          displayResult("friendsResult", friends);
          return friends;
        } catch (error) {
          displayResult("friendsResult", error.message, true);
          return [];
        }
      }

      // Receipts API
      async function createReceipt() {
        try {
          const receipt = {
            name: document.getElementById("receiptName").value,
            tax: parseFloat(document.getElementById("receiptTax").value) || 0,
            tips: parseFloat(document.getElementById("receiptTips").value) || 0,
            total:
              parseFloat(document.getElementById("receiptTotal").value) || 0,
          };

          if (!receipt.name) {
            throw new Error("Receipt name is required");
          }

          const result = await apiCall("/api/receipt", "POST", receipt);
          displayResult("receiptsResult", result);
          await updateReceiptsList();

          // Clear form
          ["receiptName", "receiptTax", "receiptTips", "receiptTotal"].forEach(
            (id) => {
              document.getElementById(id).value = "";
            }
          );
        } catch (error) {
          displayResult("receiptsResult", error.message, true);
        }
      }

      async function getAllReceipts() {
        try {
          const receipts = await apiCall("/api/receipt");
          displayResult("receiptsResult", receipts);
          return receipts;
        } catch (error) {
          displayResult("receiptsResult", error.message, true);
          return [];
        }
      }

      // Items API
      async function addItem() {
        try {
          const receiptId = document.getElementById("receiptSelect").value;
          if (!receiptId) {
            throw new Error("Please select a receipt");
          }

          const item = {
            name: document.getElementById("itemName").value,
            price: parseFloat(document.getElementById("itemPrice").value) || 0,
          };

          if (!item.name) {
            throw new Error("Item name is required");
          }

          const result = await apiCall(
            `/api/receipt/${receiptId}/items`,
            "POST",
            item
          );
          displayResult("itemsResult", result);

          // Clear form
          document.getElementById("itemName").value = "";
          document.getElementById("itemPrice").value = "";
        } catch (error) {
          displayResult("itemsResult", error.message, true);
        }
      }

      // Friend Assignment API
      async function assignFriendsToReceipt() {
        try {
          const receiptId = document.getElementById(
            "receiptSelectForFriends"
          ).value;
          if (!receiptId) {
            throw new Error("Please select a receipt");
          }

          const friendIds = Array.from(
            document.querySelectorAll('input[name="friend"]:checked')
          ).map((cb) => parseInt(cb.value));

          if (friendIds.length === 0) {
            throw new Error("Please select at least one friend");
          }

          const result = await apiCall(
            `/api/receipt/${receiptId}/friends`,
            "POST",
            { friendIds }
          );
          displayResult("assignmentResult", result);

          // Clear checkboxes after successful assignment
          document
            .querySelectorAll('input[name="friend"]:checked')
            .forEach((cb) => (cb.checked = false));
        } catch (error) {
          displayResult("assignmentResult", error.message, true);
        }
      }

      // Update UI helper functions
      async function updateReceiptsList() {
        try {
          const receipts = await getAllReceipts();
          const receiptSelects = ["receiptSelect", "receiptSelectForFriends"];

          receiptSelects.forEach((selectId) => {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select a Receipt</option>';
            receipts.forEach((receipt) => {
              const option = document.createElement("option");
              option.value = receipt.id;
              option.textContent = `${receipt.name} ($${receipt.total})`;
              select.appendChild(option);
            });
          });
        } catch (error) {
          console.error("Failed to update receipts list:", error);
        }
      }

      async function updateFriendsList() {
        try {
          const friends = await getAllFriends();
          const container = document.getElementById("friendCheckboxes");
          container.innerHTML = "";

          friends.forEach((friend) => {
            const div = document.createElement("div");
            div.innerHTML = `
                        <input type="checkbox" name="friend" value="${friend.id}" id="friend${friend.id}">
                        <label for="friend${friend.id}">${friend.name}</label>
                    `;
            container.appendChild(div);
          });
        } catch (error) {
          console.error("Failed to update friends list:", error);
        }
      }

      // Initialize the UI
      window.onload = async function () {
        await updateReceiptsList();
        await updateFriendsList();
      };
    </script>
  </body>
</html>
